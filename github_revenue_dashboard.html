<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omsetning Dashboard 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0f0f0f;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: #e4e4e7;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #06b6d4);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #9ca3af;
            font-weight: 400;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid #374151;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: #6366f1;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #f3f4f6;
        }

        .stat-change {
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .neutral { color: #6b7280; }

        .months-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .month-card {
            background: rgba(30, 30, 30, 0.9);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #374151;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .month-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-color);
        }

        .month-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-color);
        }

        .month-name {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .month-amount {
            font-size: 2.2rem;
            font-weight: 700;
            color: #f3f4f6;
            margin-bottom: 12px;
        }

        .month-progress {
            width: 100%;
            height: 8px;
            background: #374151;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .month-progress-bar {
            height: 100%;
            background: var(--accent-color);
            border-radius: 4px;
            transition: width 0.8s ease;
        }

        .month-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--accent-color);
            font-weight: 600;
        }

        .month-meta {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 8px;
        }

        .quarterly-section {
            margin-bottom: 40px;
        }

        .quarterly-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #f3f4f6;
        }

        .quarterly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .quarter-card {
            background: rgba(30, 30, 30, 0.9);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #374151;
        }

        .quarter-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 16px;
        }

        .quarter-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f3f4f6;
        }

        .quarter-total {
            font-size: 1.8rem;
            font-weight: 700;
            color: #f3f4f6;
        }

        .quarter-average {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-top: 4px;
        }

        .quarter-months {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .quarter-month {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: rgba(55, 65, 81, 0.5);
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .insights-section {
            background: rgba(30, 30, 30, 0.9);
            border-radius: 16px;
            padding: 32px;
            border: 1px solid #374151;
        }

        .insights-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 24px;
            color: #f3f4f6;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
        }

        .insight-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .insight-icon {
            font-size: 1.5rem;
        }

        .insight-content {
            flex: 1;
        }

        .insight-label {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .insight-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f3f4f6;
        }

        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-stable { color: #f59e0b; }

        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .months-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Status colors */
        .status-excellent { --accent-color: #10b981; }
        .status-good { --accent-color: #3b82f6; }
        .status-fair { --accent-color: #f59e0b; }
        .status-poor { --accent-color: #ef4444; }

        .edit-mode {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 16px;
            max-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .edit-mode.active {
            display: block;
        }

        .edit-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            z-index: 1001;
        }

        .edit-input {
            width: 100%;
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 6px;
            padding: 8px 12px;
            color: #f3f4f6;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .edit-label {
            display: block;
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="title">💰 Omsetning Dashboard 2025</h1>
            <p class="subtitle">Fullstendig oversikt over månedlig og kvartalsvis utvikling</p>
        </header>

        <section class="stats-overview">
            <div class="stat-card">
                <div class="stat-label">Total Omsetning</div>
                <div class="stat-value" id="totalRevenue">0 kr</div>
                <div class="stat-change" id="totalChange">+0% fra i fjor</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Månedlig Snitt</div>
                <div class="stat-value" id="avgRevenue">0 kr</div>
                <div class="stat-change" id="avgChange">Basert på data så langt</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Beste Måned</div>
                <div class="stat-value" id="bestMonth">-</div>
                <div class="stat-change" id="bestAmount">0 kr</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Måloppnåelse</div>
                <div class="stat-value" id="goalProgress">0%</div>
                <div class="stat-change" id="goalStatus">av årsmål</div>
            </div>
        </section>

        <section class="months-grid" id="monthsGrid">
            <!-- Months will be populated by JavaScript -->
        </section>

        <section class="quarterly-section">
            <h2 class="quarterly-title">📊 Kvartalsvis Oversikt</h2>
            <div class="quarterly-grid" id="quartersGrid">
                <!-- Quarters will be populated by JavaScript -->
            </div>
        </section>

        <section class="insights-section">
            <h2 class="insights-title">📈 Innsikt & Analyse</h2>
            <div class="insights-grid" id="insightsGrid">
                <!-- Insights will be populated by JavaScript -->
            </div>
        </section>
    </div>

    <button class="edit-toggle" onclick="toggleEdit()">✏️ Rediger Data</button>
    
    <div class="edit-mode" id="editMode">
        <h3 style="margin-bottom: 16px; color: #f3f4f6;">Rediger Månedlige Tall</h3>
        <div id="editInputs"></div>
        <button onclick="updateData()" style="width: 100%; background: #10b981; color: white; border: none; padding: 12px; border-radius: 6px; margin-top: 16px; cursor: pointer;">Oppdater Dashboard</button>
    </div>

    <script>
        // ==============================
        // NOTION API CONFIGURATION
        // ==============================
        const NOTION_CONFIG = {
            // UPDATE THESE VALUES:
            databaseId: '241d3b80-905c-809f-b3d1-000b65f1d57b', // ✅ Your database ID  
            token: 'secret_ntn_568328561569u45Y2kwgQCnf6lB5HSC3O1442AnzCJN5xi'  // ✅ Your integration token
        };

        // ==============================
        // FALLBACK DATA FOR TESTING
        // ==============================
        const fallbackData = {
            januar: 87500,
            februar: 92300,
            mars: 78900,
            april: 105400,
            mai: 88750,
            juni: 96200,
            juli: 112800,
            august: 71500,
            september: 0,      // Placeholder for future months
            oktober: 0,
            november: 0,
            desember: 0
        };

        const monthlyGoal = 80000;  // Your monthly target
        const yearlyGoal = monthlyGoal * 12;

        // Month names and data
        const months = [
            'januar', 'februar', 'mars', 'april', 'mai', 'juni',
            'juli', 'august', 'september', 'oktober', 'november', 'desember'
        ];

        const monthNamesDisplay = [
            'Januar', 'Februar', 'Mars', 'April', 'Mai', 'Juni',
            'Juli', 'August', 'September', 'Oktober', 'November', 'Desember'
        ];

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('nb-NO', {
                style: 'currency',
                currency: 'NOK',
                maximumFractionDigits: 0
            }).format(amount).replace('NOK', 'kr');
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('nb-NO').format(num);
        }

        function getMonthStatus(amount, goal) {
            const percentage = (amount / goal) * 100;
            if (amount === 0) return { class: 'status-poor', label: 'Ingen data', icon: '⏳', percentage: 0 };
            if (percentage >= 130) return { class: 'status-excellent', label: 'Fantastisk', icon: '🚀', percentage };
            if (percentage >= 110) return { class: 'status-excellent', label: 'Utmerket', icon: '⭐', percentage };
            if (percentage >= 90) return { class: 'status-good', label: 'Bra', icon: '👍', percentage };
            if (percentage >= 70) return { class: 'status-fair', label: 'OK', icon: '📈', percentage };
            return { class: 'status-poor', label: 'Under mål', icon: '🎯', percentage };
        }

        function calculateStats(revenueData) {
            const values = Object.values(revenueData);
            const nonZeroValues = values.filter(v => v > 0);
            
            const total = values.reduce((sum, val) => sum + val, 0);
            const average = nonZeroValues.length ? total / nonZeroValues.length : 0;
            const currentMonthIndex = new Date().getMonth();
            const completedMonths = Math.min(currentMonthIndex + 1, nonZeroValues.length);
            
            // Find best and worst months
            let bestMonth = { name: '-', amount: 0, index: -1 };
            let worstMonth = { name: '-', amount: Infinity, index: -1 };
            
            nonZeroValues.forEach((amount, idx) => {
                const actualIndex = values.findIndex(v => v === amount && values.indexOf(v) >= idx);
                if (amount > bestMonth.amount) {
                    bestMonth = { name: monthNamesDisplay[actualIndex], amount, index: actualIndex };
                }
                if (amount < worstMonth.amount && actualIndex <= currentMonthIndex) {
                    worstMonth = { name: monthNamesDisplay[actualIndex], amount, index: actualIndex };
                }
            });

            const goalProgress = (total / yearlyGoal) * 100;
            const projectedAnnual = completedMonths > 0 ? (total / completedMonths) * 12 : 0;

            return {
                total,
                average,
                bestMonth,
                worstMonth,
                goalProgress,
                projectedAnnual,
                completedMonths,
                remainingMonths: 12 - completedMonths
            };
        }

        function renderOverviewStats(revenueData) {
            const stats = calculateStats(revenueData);
            
            document.getElementById('totalRevenue').textContent = formatCurrency(stats.total);
            document.getElementById('avgRevenue').textContent = formatCurrency(stats.average);
            document.getElementById('bestMonth').textContent = stats.bestMonth.name;
            document.getElementById('bestAmount').textContent = formatCurrency(stats.bestMonth.amount);
            document.getElementById('goalProgress').textContent = Math.round(stats.goalProgress) + '%';
            
            // Update change indicators
            const totalChange = document.getElementById('totalChange');
            const goalStatus = document.getElementById('goalStatus');
            
            if (stats.projectedAnnual > yearlyGoal) {
                goalStatus.textContent = 'Ligger an til å nå målet! 🎯';
                goalStatus.className = 'stat-change positive';
            } else if (stats.projectedAnnual > yearlyGoal * 0.9) {
                goalStatus.textContent = 'Nær målet 📈';
                goalStatus.className = 'stat-change neutral';
            } else {
                goalStatus.textContent = 'Under årsmål ⚠️';
                goalStatus.className = 'stat-change negative';
            }
        }

        function renderMonths(revenueData) {
            const grid = document.getElementById('monthsGrid');
            const currentMonth = new Date().getMonth();
            
            grid.innerHTML = months.map((month, index) => {
                const amount = revenueData[month];
                const status = getMonthStatus(amount, monthlyGoal);
                const isCurrentMonth = index === currentMonth;
                const isFutureMonth = index > currentMonth;
                
                return `
                    <div class="month-card ${status.class}">
                        <div class="month-name">
                            ${monthNamesDisplay[index]} ${isCurrentMonth ? '(Inneværende)' : ''} ${isFutureMonth ? '(Kommende)' : ''}
                        </div>
                        <div class="month-amount">
                            ${amount > 0 ? formatCurrency(amount) : '—'}
                        </div>
                        <div class="month-progress">
                            <div class="month-progress-bar" style="width: ${Math.min(status.percentage, 100)}%"></div>
                        </div>
                        <div class="month-status">
                            <span>${status.icon}</span>
                            <span>${status.label}</span>
                            ${amount > 0 ? `<span>(${Math.round(status.percentage)}%)</span>` : ''}
                        </div>
                        <div class="month-meta">
                            Mål: ${formatCurrency(monthlyGoal)}
                            ${amount > 0 ? ` • Differanse: ${formatCurrency(amount - monthlyGoal)}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderQuarters(revenueData) {
            const grid = document.getElementById('quartersGrid');
            const quarters = [
                { name: 'Q1 2025', months: [0, 1, 2], label: 'Jan-Mar' },
                { name: 'Q2 2025', months: [3, 4, 5], label: 'Apr-Jun' },
                { name: 'Q3 2025', months: [6, 7, 8], label: 'Jul-Sep' },
                { name: 'Q4 2025', months: [9, 10, 11], label: 'Okt-Des' }
            ];

            grid.innerHTML = quarters.map(quarter => {
                const total = quarter.months.reduce((sum, monthIdx) => {
                    return sum + revenueData[months[monthIdx]];
                }, 0);
                const average = total / 3;
                const hasData = quarter.months.some(monthIdx => revenueData[months[monthIdx]] > 0);
                const quarterGoal = monthlyGoal * 3;
                const achievement = (total / quarterGoal) * 100;

                return `
                    <div class="quarter-card">
                        <div class="quarter-header">
                            <div>
                                <div class="quarter-name">${quarter.name}</div>
                                <div style="font-size: 0.8rem; color: #9ca3af;">${quarter.label}</div>
                            </div>
                        </div>
                        <div class="quarter-total">${hasData ? formatCurrency(total) : '—'}</div>
                        <div class="quarter-average">
                            Snitt: ${hasData ? formatCurrency(average) : '—'}
                            ${hasData ? ` • ${Math.round(achievement)}% av mål` : ''}
                        </div>
                        <div class="quarter-months">
                            ${quarter.months.map(monthIdx => {
                                const amount = revenueData[months[monthIdx]];
                                return `
                                    <div class="quarter-month">
                                        <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 4px;">
                                            ${monthNamesDisplay[monthIdx].substring(0, 3)}
                                        </div>
                                        <div style="font-weight: 600; color: ${amount > 0 ? '#f3f4f6' : '#6b7280'};">
                                            ${amount > 0 ? formatNumber(amount/1000) + 'k' : '—'}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderInsights(revenueData) {
            const grid = document.getElementById('insightsGrid');
            const stats = calculateStats(revenueData);
            const values = Object.values(revenueData).filter(v => v > 0);
            
            // Calculate trends
            const lastThreeMonths = values.slice(-3);
            const trend = lastThreeMonths.length >= 2 ? 
                (lastThreeMonths[lastThreeMonths.length - 1] > lastThreeMonths[0] ? 'up' : 
                 lastThreeMonths[lastThreeMonths.length - 1] < lastThreeMonths[0] ? 'down' : 'stable') : 'stable';

            const trendIcon = trend === 'up' ? '📈' : trend === 'down' ? '📉' : '➡️';
            const trendClass = `trend-${trend}`;
            const trendText = trend === 'up' ? 'Stigende' : trend === 'down' ? 'Fallende' : 'Stabil';

            const insights = [
                {
                    icon: '🎯',
                    label: 'Gjenstående til årsmål',
                    value: formatCurrency(Math.max(0, yearlyGoal - stats.total))
                },
                {
                    icon: '📊',
                    label: 'Forventet årlig omsetning',
                    value: formatCurrency(stats.projectedAnnual)
                },
                {
                    icon: trendIcon,
                    label: 'Trend siste måneder',
                    value: trendText,
                    class: trendClass
                },
                {
                    icon: '📅',
                    label: 'Måneder igjen',
                    value: `${stats.remainingMonths} måneder`
                },
                {
                    icon: '💪',
                    label: 'Nødvendig per måned',
                    value: stats.remainingMonths > 0 ? formatCurrency((yearlyGoal - stats.total) / stats.remainingMonths) : 'Mål nådd! 🎉'
                },
                {
                    icon: '🏆',
                    label: 'Best vs Verst',
                    value: `${Math.round((stats.bestMonth.amount / stats.worstMonth.amount) * 100)}% forskjell`
                }
            ];

            grid.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-icon">${insight.icon}</div>
                    <div class="insight-content">
                        <div class="insight-label">${insight.label}</div>
                        <div class="insight-value ${insight.class || ''}">${insight.value}</div>
                    </div>
                </div>
            `).join('');
        }

        // Notion API functions
        async function fetchNotionData() {
            try {
                const response = await fetch(`https://api.notion.com/v1/databases/${NOTION_CONFIG.databaseId}/query`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${NOTION_CONFIG.token}`,
                        'Content-Type': 'application/json',
                        'Notion-Version': '2022-06-28'
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return parseNotionData(data);
            } catch (error) {
                console.error('Error fetching Notion data:', error);
                return null;
            }
        }

        function parseNotionData(notionResponse) {
            const revenueData = {};
            
            notionResponse.results.forEach(page => {
                const monthProperty = page.properties['Måned'] || page.properties['Month'];
                const revenueProperty = page.properties['Omsetning'] || page.properties['Revenue'];
                
                if (monthProperty && revenueProperty) {
                    const month = monthProperty.title[0]?.text?.content?.toLowerCase();
                    const revenue = revenueProperty.number || 0;
                    
                    if (month && months.includes(month)) {
                        revenueData[month] = revenue;
                    }
                }
            });

            return revenueData;
        }

        function renderDashboard(revenueData) {
            renderOverviewStats(revenueData);
            renderMonths(revenueData);
            renderQuarters(revenueData);
            renderInsights(revenueData);
        }

        // Initialize dashboard
        async function initDashboard() {
            let revenueData = null;

            // Try to fetch from Notion first
            if (NOTION_CONFIG.databaseId !== 'YOUR_NOTION_DATABASE_ID_HERE' && 
                NOTION_CONFIG.token !== 'YOUR_NOTION_INTEGRATION_TOKEN_HERE') {
                revenueData = await fetchNotionData();
            }

            // Fall back to test data if Notion fails
            if (!revenueData) {
                console.log('Using fallback data for demonstration');
                revenueData = fallbackData;
            }

            renderDashboard(revenueData);
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>